import os
import numpy as np
import pandas as pd

from math import sqrt
from zipfile import ZipFile
from PIL import Image
from tqdm import tqdm

def extract_zip(zip_path):
    try:
        with ZipFile(zip_path, 'r') as zip:
            zip.extractall()
    except Exception as e:
        exit()

def to_img(path):
    for file in tqdm(os.listdir(path)):
        with open(os.path.join(path, file), 'rb') as content:
            stream = content.read()

            len_stream = len(stream)
            size = int(sqrt(len_stream)) + 1
            padding = size**2 - len_stream

            img = np.frombuffer(stream, dtype=np.uint8)
            img = np.append(img, [0]*padding)
            img = np.reshape(img, (size, size)).astype(np.uint8)

            img = Image.fromarray(img)
            img.save(os.path.join(f'{path}_img', f'{file}.jpg'))

def create_df(path):
    label = None

    if 'SMS' in path:
        label = 'SMS'
    elif 'Adware' in path:
        label = 'Adware'
    elif 'Banking' in path:
        label = 'Banking'
    elif 'Riskware' in path:
        label = 'Riskware'
    elif 'Benign' in path:
        label = 'Benign'

    dict_mal = {
        'file_name' :[],
        'type' : [],
    }

    for img in tqdm(os.listdir(path)):
        dict_mal['file_name'].append(img)
        dict_mal['type'].append('xml' if 'xml' in img else 'dex')
    
    df = pd.DataFrame(dict_mal)

    df['path'] = path
    df['label'] = label

    return df

if __name__ == "__main__":

    zips = ['SMS.zip', 'Banking.zip', 'Adware.zip']
    paths = ['SMS_extract', 'Banking_extract', 'Adware_extract']
    dfs = []

    for z, p in zip(zips, paths):
        extract_zip(z)
        os.makedirs(f'{p}_img')
        to_img(p)
        df = create_df(f'{p}_img')
        dfs.append(df)

    full_df = pd.concat(dfs)
    full_df.to_csv('metadata.csv', index=False)

